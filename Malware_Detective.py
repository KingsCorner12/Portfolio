import time
import os
import psutil
import logging
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from pathlib import Path

# Config
WATCH_DIRS = [
    str(Path.home() / "Desktop"),     # Watches Desktop
    str(Path.home() / "Documents"),   # Watches Documents
    str(Path.home() / "Downloads")    # Watches Downloads
]

SUSPICIOUS_KEYWORDS = [
    "svchost", "temp", "keylog", "hidden", "payload",
    "inject", "createremotethread", "virtualallocex", "socket"
]
CPU_USAGE_THRESHOLD = 40.0  # % CPU that might be suspicious


# Logging Setup
log_dir = "logs"
os.makedirs(log_dir, exist_ok=True)
LOG_FILE = os.path.join(log_dir, "detection.log")

logging.basicConfig(
    filename=LOG_FILE,
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# Logging Helpers
def log_suspicious(msg):
    print(f"[!] {msg}")
    logging.warning(msg)

def log_info(msg):
    print(f"[i] {msg}")
    logging.info(msg)

# File Monitoring
class FileMonitor(FileSystemEventHandler):
    def on_created(self, event):
        filepath = event.src_path
        if not event.is_directory:
            if is_hidden(filepath):
                log_suspicious(f"Hidden file created: {filepath}")
            else:
                log_info(f"File created: {filepath}")

    def on_deleted(self, event):
        if not event.is_directory:
            log_info(f"File deleted: {event.src_path}")

def is_hidden(filepath):
    name = os.path.basename(filepath)
    return name.startswith('.') or "hidden" in name.lower()

# Process Monitoring
def scan_processes():
    for proc in psutil.process_iter(['pid', 'name', 'exe', 'cpu_percent']):
        try:
            name = proc.info['name'] or ""
            exe = proc.info['exe'] or ""
            cpu = proc.info['cpu_percent']

            if any(keyword in name.lower() for keyword in SUSPICIOUS_KEYWORDS):
                log_suspicious(f"Suspicious process name: {name} (PID: {proc.pid})")

            if exe and ("AppData" in exe or "Temp" in exe):
                log_suspicious(f"Process running from temp directory: {exe} (PID: {proc.pid})")

            if cpu and cpu > CPU_USAGE_THRESHOLD:
                log_suspicious(f"High CPU usage: {name} using {cpu:.1f}% (PID: {proc.pid})")

        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            continue

# Main Loop
def main():
    valid_watch_dirs = []

    for path in WATCH_DIRS:
        if os.path.exists(path):
            valid_watch_dirs.append(path)
        else:
            print(f"[x] WARNING: Folder does not exist and will be skipped: {path}")

    if not valid_watch_dirs:
        print("[x] ERROR: No valid folders to monitor. Exiting.")
        return

    print(f"Logging to: {LOG_FILE}")
    print("Press Ctrl+C to stop.\n")

    observers = []

    for path in valid_watch_dirs:
        print(f"Monitoring folder: {path}")
        event_handler = FileMonitor()
        observer = Observer()
        observer.schedule(event_handler, path, recursive=True)
        observer.start()
        observers.append(observer)

    try:
        while True:
            scan_processes()
            time.sleep(5)
    except KeyboardInterrupt:
        print("Stopping monitoring...")
        for observer in observers:
            observer.stop()
    for observer in observers:
        observer.join()
if __name__ == "__main__":
    main()
